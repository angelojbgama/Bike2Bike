{% extends 'base.html' %}
{% block title %}Calcular Rota - Tem Bike{% endblock %}
{% block content %}

<div class="container-fluid mt-5 py-4">
  <div class="row">
    <!-- Barra lateral com detalhes do percurso -->
    <div class="col-md-4 p-4 bg-light" id="sidebar">
      <h3>Detalhes do Percurso</h3>
      <div id="routeDetails" style="display: none;">
        <p><strong>Distância:</strong> <span id="routeDistance">N/A</span></p>
        <p><strong>Tempo Estimado:</strong> <span id="routeTime">N/A</span></p>
        <h5 class="mt-4">Instruções:</h5>
        <ul id="instructions" class="list-group"></ul>
      </div>
      <div class="mt-4">
        <button class="btn btn-secondary w-100 mb-2" id="resetRouteButton">Redefinir Rota</button>
        <button class="btn btn-primary w-100" id="getLocationButton">Minha Localização</button>
      </div>
    </div>

    <!-- Mapa Leaflet -->
    <div class="col-md-8">
      <div id="map" style="height: 600px;"></div>
    </div>
  </div>
</div>

<!-- Leaflet JS e CSS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
      var map = L.map('map').setView([-23.55052, -46.6333], 13);  // Exemplo: São Paulo, Brasil

      // Adiciona a camada de mapa
      L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 18
      }).addTo(map);

      let startPoint = null;
      let endPoint = null;
      let routeLayer = null;  // Variável para armazenar a camada da rota

      // Evento de clique no mapa para definir pontos de partida e destino
      map.on('click', function (e) {
          if (!startPoint) {
              startPoint = e.latlng;
              L.marker(startPoint).addTo(map).bindPopup('Local de Partida').openPopup();
          } else if (!endPoint) {
              endPoint = e.latlng;
              L.marker(endPoint).addTo(map).bindPopup('Local de Destino').openPopup();
              calcularRota();
          }
      });

      // Função para calcular e exibir a rota
      function calcularRota() {
          L.Routing.control({
              waypoints: [L.latLng(startPoint), L.latLng(endPoint)],
              createMarker: function() { return null; },  // Remove marcadores automáticos
              lineOptions: { styles: [{ color: 'blue', weight: 4 }] },
              show: false,  // Oculta painel padrão
              router: L.Routing.osrmv1({
                  serviceUrl: 'https://router.project-osrm.org/route/v1'
              })
          }).on('routesfound', function (e) {
              var route = e.routes[0];
              var distance = (route.summary.totalDistance / 1000).toFixed(2) + ' km';
              var time = Math.round(route.summary.totalTime / 60) + ' minutos';

              // Exibe as informações na barra lateral
              document.getElementById('routeDistance').textContent = distance;
              document.getElementById('routeTime').textContent = time;
              document.getElementById('routeDetails').style.display = 'block';

              // Adiciona as instruções na lista
              var instructions = document.getElementById('instructions');
              instructions.innerHTML = '';  // Limpa instruções anteriores
              route.instructions.forEach(function (step) {
                  var li = document.createElement('li');
                  li.classList.add('list-group-item');
                  li.textContent = step.text;
                  instructions.appendChild(li);
              });

              // Adiciona a rota no mapa
              if (routeLayer) map.removeLayer(routeLayer);  // Remove rota anterior se existir
              routeLayer = L.Routing.line(route).addTo(map);
          }).addTo(map);
      }

      // Botão para redefinir a rota
      document.getElementById('resetRouteButton').addEventListener('click', function () {
          startPoint = null;
          endPoint = null;
          if (routeLayer) map.removeLayer(routeLayer);  // Remove a camada da rota
          map.eachLayer(function (layer) {
              if (layer instanceof L.Marker) {
                  map.removeLayer(layer);
              }
          });
          document.getElementById('routeDetails').style.display = 'none';
      });

      // Botão para capturar a localização atual
      document.getElementById('getLocationButton').addEventListener('click', function () {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function (position) {
                  var lat = position.coords.latitude;
                  var lon = position.coords.longitude;
                  L.marker([lat, lon]).addTo(map).bindPopup('Você está aqui!').openPopup();
                  map.setView([lat, lon], 15);
              }, function () {
                  alert('Não foi possível obter sua localização.');
              });
          } else {
              alert('Geolocalização não é suportada pelo seu navegador.');
          }
      });
  });
</script>

{% endblock %}
