{% extends "base.html" %}
{% load static %}

{% block extra_head %}
  <!-- Carrega o CSS do Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
  <!-- Carrega o CSS do Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    /* Define a altura do mapa para que ele seja renderizado */
    #map { height: 400px; }
  </style>
{% endblock %}

{% block content %}
<div class="container mx-auto py-8 max-w-2xl">
  <h1 class="text-2xl font-bold mb-4">Criar Post de Trajeto de Bike</h1>
  <form method="post">
    {% csrf_token %}
    
    <!-- Campo: Título -->
    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text font-medium">Título</span>
      </label>
      {{ form.title }}
      {% if form.title.errors %}
      <span class="text-error">{{ form.title.errors }}</span>
      {% endif %}
    </div>
    
    <!-- Campo oculto para armazenar a trajetória gerada automaticamente -->
    {{ form.bike_trajectory_data }}

    <!-- Botões para usar as coordenadas do dispositivo e limpar o mapa -->
    <div class="mb-4 flex justify-end space-x-2">
      <button id="locate-btn" class="btn btn-sm btn-primary" type="button">
        Usar minhas coordenadas
      </button>
      <button id="clear-btn" class="btn btn-sm btn-secondary" type="button">
        Limpar Mapa
      </button>
    </div>

    <!-- Instrução para o usuário -->
    <div class="mb-2">
      <p class="text-sm text-gray-600">
        Clique em dois pontos no mapa para definir a origem e o destino da rota (preferindo as ciclovias).
      </p>
    </div>
    
    <!-- Container do mapa -->
    <div id="map" class="rounded-lg shadow-lg mb-4"></div>
    
    <!-- Div para exibir detalhes do trajeto, como a quilometragem -->
    <div id="route-details" class="mb-4 text-center text-sm text-gray-600"></div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Criar Post</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
  <!-- Carrega o JavaScript do Leaflet -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
  <!-- Carrega o JavaScript do Leaflet Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Inicializa o mapa com centro em [0, 0] e zoom 2
      var map = L.map('map').setView([0, 0], 2);
      
      // Adiciona a camada de tiles do OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      
      // Variáveis de estado para armazenar pontos, marcadores e o controle de rota
      var waypoints = [];
      var markers = []; // Armazena os marcadores adicionados no mapa
      var routeControl = null;
      
      // Função para adicionar um marcador e armazená-lo no array "markers"
      function addMarker(latlng) {
        var marker = L.marker(latlng).addTo(map);
        markers.push(marker);
      }
      
      // Evento de clique no mapa: registra até dois pontos (origem e destino)
      map.on('click', function(e) {
        if (waypoints.length >= 2) return; // Limita a dois pontos
        var latlng = e.latlng;
        waypoints.push(latlng);
        addMarker(latlng);
        
        // Se dois pontos foram selecionados, calcula a rota automaticamente
        if (waypoints.length === 2) {
          // Se existir uma rota anterior, remova-a
          if (routeControl !== null) {
            map.removeControl(routeControl);
          }
          // Cria o controle de rota usando o serviço OSRM com o perfil "cycling"
          routeControl = L.Routing.control({
            waypoints: waypoints,
            router: new L.Routing.OSRMv1({
              serviceUrl: 'https://router.project-osrm.org/route/v1',
              profile: 'cycling' // Define o perfil para rotas de bicicleta
            }),
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: false,  // Oculta o painel de rotas
            createMarker: function(i, wp) {
              return L.marker(wp.latLng);
            }
          }).addTo(map);
          
          // Quando a rota é encontrada, salva as coordenadas e mostra detalhes como distância
          routeControl.on('routesfound', function(e) {
            var route = e.routes[0];
            var hiddenInput = document.querySelector('[name="bike_trajectory_data"]');
            if (hiddenInput) {
              hiddenInput.value = JSON.stringify(route.coordinates);
            }
            if (route.summary) {
              // Converte a distância de metros para quilômetros, formatada com 2 casas decimais
              var km = (route.summary.totalDistance / 1000).toFixed(2);
              var detailsDiv = document.getElementById("route-details");
              if (detailsDiv) {
                detailsDiv.innerHTML = "<p>Distância: " + km + " km</p>";
              }
            }
          });
        }
      });
      
      // Funcionalidade do botão "Usar minhas coordenadas"
      var locateBtn = document.getElementById("locate-btn");
      locateBtn.addEventListener("click", function(e) {
        e.preventDefault();
        map.locate({setView: true, maxZoom: 16});
      });
      
      // Ao encontrar a localização, adiciona um marcador e um círculo representando a precisão
      map.on("locationfound", function(e) {
        var radius = e.accuracy;
        L.marker(e.latlng).addTo(map)
          .bindPopup("Você está aqui.").openPopup();
        L.circle(e.latlng, radius).addTo(map);
      });
      
      // Em caso de erro na localização, exibe um alerta
      map.on("locationerror", function(e) {
        alert("Não foi possível localizar sua posição: " + e.message);
      });
      
      // Funcionalidade do botão "Limpar Mapa" para reiniciar o processo
      var clearBtn = document.getElementById("clear-btn");
      clearBtn.addEventListener("click", function(e) {
        e.preventDefault();
        
        // Remove todos os marcadores adicionados
        markers.forEach(function(marker) {
          map.removeLayer(marker);
        });
        markers = [];
        
        // Remove o controle de rota, se houver, e reseta a variável
        if (routeControl !== null) {
          map.removeControl(routeControl);
          routeControl = null;
        }
        
        // Limpa os waypoints e a área de detalhes da rota
        waypoints = [];
        var detailsDiv = document.getElementById("route-details");
        if (detailsDiv) {
          detailsDiv.innerHTML = "";
        }
        
        // Limpa o valor do campo oculto (trajetória)
        var hiddenInput = document.querySelector('[name="bike_trajectory_data"]');
        if (hiddenInput) {
          hiddenInput.value = "";
        }
      });
    });
  </script>
{% endblock %}
